name: Oracle Cloud Instance Requester
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  launch-instance:
    runs-on: ubuntu-latest
    steps:
      - name: Install OCI CLI
        run: |
          curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults
          echo "/home/runner/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_KEY_FILE }}" > /home/runner/.oci/key.pem
          chmod 600 /home/runner/.oci/key.pem
          
          echo "[DEFAULT]" > /home/runner/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> /home/runner/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> /home/runner/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> /home/runner/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> /home/runner/.oci/config
          echo "key_file=/home/runner/.oci/key.pem" >> /home/runner/.oci/config
          chmod 600 /home/runner/.oci/config

      - name: Try Create Instance
        run: |
          oci compute instance launch \
          --compartment-id "${{ secrets.COMPARTMENT_ID }}" \
          --availability-domain "Kres:AP-SINGAPORE-1-AD-1" \
          --shape "VM.Standard.E2.1.Micro" \
          --subnet-id "${{ secrets.SUBNET_ID }}" \
          --image-id "${{ secrets.IMAGE_ID }}" \
          --assign-public-ip true \
          --display-name "MyFreeServer" \
          --metadata "{\"ssh_authorized_keys\": \"${{ secrets.SSH_PUBLIC_KEY }}\"}"
