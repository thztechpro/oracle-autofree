name: Oracle Cloud Instance Requester
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  launch-instance:
    runs-on: ubuntu-latest
    steps:
      - name: Install OCI CLI
        run: |
          curl -L -O https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh
          chmod +x install.sh
          ./install.sh --accept-all-defaults
          echo "/home/runner/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p /home/runner/.oci
          # Private Key ကို Secret မှတစ်ဆင့် ဖိုင်တည်ဆောက်ခြင်း
          echo "${{ secrets.OCI_KEY_FILE }}" > /home/runner/.oci/key.pem
          chmod 600 /home/runner/.oci/key.pem
          
          # Config ဖိုင်ကို တည်ဆောက်ခြင်း
          cat <<EOF > /home/runner/.oci/config
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=/home/runner/.oci/key.pem
          EOF
          chmod 600 /home/runner/.oci/config

      - name: Try Create Instance
        run: |
          # SSH Public Key ထဲက line breaks တွေကို ဖယ်ရှားခြင်း
          CLEAN_SSH_KEY=$(echo "${{ secrets.SSH_PUBLIC_KEY }}" | tr -d '\n\r')
          
          # Instance Launch Command
          oci compute instance launch \
          --compartment-id "${{ secrets.COMPARTMENT_ID }}" \
          --availability-domain "Kres:AP-SINGAPORE-1-AD-1" \
          --shape "VM.Standard.E2.1.Micro" \
          --subnet-id "${{ secrets.SUBNET_ID }}" \
          --image-id "${{ secrets.IMAGE_ID }}" \
          --assign-public-ip true \
          --display-name "MyFreeServer" \
          --metadata "{\"ssh_authorized_keys\": \"$CLEAN_SSH_KEY\"}"
